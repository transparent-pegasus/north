# 実装計画: 分解・改善ロジックの高度化と不具合修正

## 概要

`docs/todo.md` に記載された残課題に基づき、AIによる提案ロジックの改善、UIの微調整、およびリサーチ機能の致命的な不具合（Error: Target node not found）の修正を行う。

## 変更内容

### 1. UIの調整

- **下部ナビゲーション**: モバイル表示において、アイコンのみのデザインに変更し、サイズを最適化。
- **ゴール選択**: "SELECT GOAL" を「ゴールを選択」に変更。
- **要素詳細画面**: モーダル等の高さが画面外にはみ出さないよう、画面縦幅を最大限（かつ自然な範囲で）活用するレイアウトに変更。要素の高さを可能な限り大きく確保し、それでも入り切らない場合のみ内部スクロールを有効にする。

### 2. 提案・改善ロジックの高度化

- **データ構造の拡張**:
  - AIに対して「維持すべき理由」と「変更すべき理由」を生成させる。
  - プロンプトおよびUIにおいて、「維持すべき理由」「変更すべき理由」という見出しを採用し、英語の補足説明（"Reason for..."等）を削除する。
- **改善提案の対象拡大**:
  - 「理想の状態」に対しては、`理想の状態`・`条件`・`現状` の3項目をセットで整合性を保ちながら修正提案するように拡張する。
  - 「ゴール」に対しては、`content` のみを対象とする（従来通りだが、理由付けを強化）。
  - いずれの場合も、「維持すべき理由」と「変更すべき理由」を明確に提示する。
- **分解処理の最適化**:
  - `decompose` 関数において、現在は `maxItems` に達するまで無条件で追加しようとするが、既存要素との重複排除や洗練をより重視するプロンプトへ改善。
  - 1回の「分解」で実行されるAIリクエストのログ出力を整理し、意図したサイクル（3周ループ）が正しく動作しているか可視化・検証可能にする。

### 3. 不具合修正（リサーチ機能）

- **エラー修正**: `Error: Target node not found` の解消。
  - `saveResearchSearchResults` において、`idealStates` から `nodeId` が見つからないケースの調査。
  - 特に、手動追加時や自動リサーチ実行時に、フロントエンドから渡される `nodeId` が正しいか、バックエンドで取得する `tree` が最新の状態（分解直後など）であるかを確認する。
  - 非同期処理中の競合（Treeの保存とリサーチ結果の保存が重なるなど）がないか検討。

## タスクリスト

### Phase 1: UI & 小規模修正

- [x] `frontend/components/BottomNavigation.tsx`: アイコンのみのスタイルに修正。
- [x] `frontend/components/TreeSelectorDrawer.tsx`: ラベルを日本語に変更。
- [x] `frontend/components/ControlPanelModal.tsx` および `ControlPanel.tsx`: `flex` レイアウトや `max-h-[85vh]` 等を活用し、画面高さを最大限利用しつつ、必要に応じて内部スクロールが発生するように調整。

### Phase 2: 改善（Refinement）ロジックの強化

- [x] `types/index.ts` および `backend/src/types.ts`: `ElementProposal` のデータ構造を修正。
- [x] `backend/src/refinement.ts`: プロンプトを更新し、「理想の状態・条件・現状」をセットで提案するように変更。
- [x] `frontend/components/ControlPanel.tsx`: 提案内容（維持理由・変更理由）を表示し、個別または一括で適用できるUIを実装。

### Phase 3: リサーチ機能の不具合修正

- [x] `backend/src/research.ts` & `tree.ts`: `Target node not found` エラーのデバッグログ追加と、Tree取得ロジックの堅牢化。
- [x] リサーチ結果保存時の `nodeId` 検索処理におけるエラーハンドリングの改善。
- [x] 手動追加リサーチのパスを検証し、`nodeId` の不一致を修正。

### Phase 4: 検証

- [x] `backend/src/__tests__/decomposition.test.ts` (新規): 分解処理のサイクルとレスポンス形式を検証するテストコードの実装。
- [x] `make verify` による全体の整合性確認。

## 検証計画

- **UI**: モバイルシミュレータで下部ナビと詳細画面の挙動を確認。
- **AI**: 「修正提案」を実行し、維持理由・変更理由が含まれた新しい提案が生成され、適用できることを確認。
- **Bug**: リサーチ（自動・手動）を実行し、Firestoreに正しく保存され、エラーが再発しないことを確認。
