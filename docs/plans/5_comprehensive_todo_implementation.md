# 実装計画: TODOリスト項目の一括対応

## 概要
`docs/todo.md` に記載された未実装項目（UI改善、AI処理の堅牢化、パフォーマンス改善）を包括的に実装する。特に、ユーザーの操作に対するレスポンス性を高めるため、**楽観的更新 (Optimistic UI)** の適用を拡大する。

## 実装項目

### 1. 要素編集モーダルの改善
- **目的**: 編集画面の視認性向上と操作フローの最適化。
- **内容**:
  - モーダルの高さを最大 `75vh` に制限し、コンテンツが多い場合のスクロールを確保する。
  - 「ツリーを独立させる（Promote to Goal）」アクション実行後、成功時にモーダルを自動的に閉じる処理を追加する。
- **対象ファイル**:
  - `frontend/components/ControlPanelModal.tsx` (モバイル用)
  - `frontend/components/ControlPanel.tsx`

### 2. リサーチ自動実行の制限 (Rate Limiting UI)
- **目的**: 1日あたりのリサーチ回数制限（3回/日）をUI上で明示し、過剰なリクエストを防止する。
- **内容**:
  - **AI処理実行（分解・修正提案）の制限表示と全く同じUI/UXにする。**
  - ユーザーの `daily_limit/{date}` ドキュメントを監視し、リサーチ実行回数が上限に達している場合、ボタンを無効化し、AI制限時と同様のメッセージやスタイルを適用する。
- **実装方針**:
  - 既存のAI制限表示ロジック（`ControlPanel` 等で使用されているもの）を再利用または共通コンポーネント化し、リサーチパネルにも適用する。

### 3. 要素分解の数値入力改善
- **目的**: 数値入力の操作性（UX）向上。
- **内容**:
  - 現在の実装（`input type="number"`）で、バックスペースによる全削除（空文字）ができない問題を修正する（値を `number | string` で扱う、または `onChange` ハンドラの調整）。
  - **※上記「バックスペースでの削除」が実装できれば、ステッパー（増減矢印）や `+` `-` ボタンの追加実装は不要とする。**

### 4. AI非同期処理の堅牢化 (Firestore State Management)
- **目的**: 画面変遷やリロードを行っても、実行中のAIプロセス（分解、リファインなど）の進行状態を正しく追跡・復帰できるようにする。
- **現状の課題**: `Promise` の待機のみで状態管理しているため、コンポーネントがアンマウントされると結果を受け取れず、失敗扱い（または不明な状態）になる。
- **解決策**:
  - **Firestoreによる状態管理**: Firestoreの `Tree` または `Element` ドキュメントに「処理中フラグ」を持たせる。
    - 例: `isAnalyzing: boolean` または `processingStatus: 'idle' | 'running' | 'completed' | 'error'`
  - **フロー変更**:
    1. フロントエンドからAPIをコール。
    2. バックエンドは即座にFirestore上の対象ドキュメントのステータスを `processing` に更新し、202 Accepted を返す（またはバックグラウンド処理を開始）。
    3. フロントエンドはFirestoreのステータス変更を検知してローディング表示を行う。
    4. バックエンド処理完了時、ステータスを `completed` に更新し、結果を書き込む。
    5. フロントエンドは完了を検知して表示を更新する。
  - これにより、画面をリロードしてもFirestoreの状態を見てローディングを継続できる。

### 5. 楽観的更新 (Optimistic UI) の実装
- **目的**: API通信の完了を待たずにUIを更新し、ユーザーに「即時反映された」ような軽快な操作感を提供する。
- **対象機能**:
  - **リサーチ結果の手動追加**: `ResearchModal.tsx`
    - 保存ボタン押下時、即座にローカルの `Tree` Stateに仮データを追加し、モーダルを閉じる。API失敗時はロールバックまたはエラー通知を行う。
  - **要素 (Goal/IdealState) の編集**: `ControlPanel.tsx`
    - 更新ボタン押下時、即座にUI上のテキスト等を更新し、グローバルローディング（画面ロック）を廃止または非ブロッキングなインジケータに変更する。
  - **要素の追加**: `TreeList.tsx`
    - モーダルで内容決定後、即座にツリーに新しいノードを追加表示する。IDは一時IDを使用するか、完了後にサーバーIDと置換する。
  - **要素の削除**: `ControlPanel.tsx`
    - 削除ボタン押下時、即座にツリーから該当ノードを非表示にする。
- **注意点**:
  - AIリクエスト系（分解、洗練、自動リサーチ）については、処理時間が長く結果予測が困難なため、楽観的更新の対象外とし、引き続き「処理中」ステータスの表示（Phase 2で強化）で対応する。
  - `TreeList` コンポーネントの状態管理ロジック（`tree` state）を一箇所で操作できるように整理する必要がある可能性がある（Context APIまたはカスタムフックの活用）。

## 作業ステップ

1. **Phase 1: UI/UX Minor Fixes** (1, 2, 3)
   - モーダルスタイル調整
   - 数値入力コンポーネント修正
   - リサーチボタンのDisableロジック追加
2. **Phase 2: Optimistic UI Implementation** (5)
   - リサーチ手動追加の楽観的更新
   - 要素（編集・追加・削除）の楽観的更新
3. **Phase 3: Backend/Deep Logic & Robustness** (4)
   - Firestoreスキーマへのステータスフィールド追加
   - バックエンド処理内でのステータス更新ロジック実装
   - フロントエンドの監視ロジック修正
   - ツリー作成数の上限チェック実装 (Phase 4から移動・統合)
4. **Phase 4: Cleanup**
   - 要素分解数の規定値変更 (5 -> 3)
   - 不要なログやコードの削除