# 実装計画: インフラ整備・認証改善・データ同期

## 概要
本計画は、`docs/todo.md` に記載されたタスクに基づき、アプリケーションの基盤整備（APIキーのリネーム、環境変数の整理）、Google Analyticsの導入、認証フローの改善（任意ログイン化とデータ同期）、およびFirestoreルールの最適化を行うことを目的とします。

## タスク一覧

### 1. 環境変数と定数の整理
- [ ] **APIキーのリネーム**
  - `GOOGLE_API_KEY` を `GEMINI_API_KEY` に変更する（Backend/Frontend両方）。
  - 関連するコード（Cloud Functions, API呼び出し箇所）を修正する。
- [ ] **Firebase設定の環境変数化**
  - 現在定数としてハードコードされているFirebase関連の値（apiKey, authDomain, projectId等）を、環境変数（`.env`）から読み込むように変更する。
  - ステージング環境と本番環境で異なる値を設定できるようにする。

### 2. Google Analyticsの導入
- [ ] **GAの初期化**
  - `@firebase/analytics` パッケージを導入/確認する。
  - `firebase.measurementId` を環境変数に追加する。
  - アプリケーション起動時に Analytics を初期化するコードを追加する。

### 3. Googleログインの任意化とデータ同期
- [ ] **任意ログイン（ゲスト利用）の実装**
  - 初回利用時にGoogleログインを強制せず、ゲスト（機能制限付き、またはAnonymous Auth）として利用できるようにする。
- [ ] **アカウント単位でのデータ一元化**
  - 現状の課題（「別端末だと同じGoogleアカウントでも違うデータ」）を調査する。
  - 認証済みユーザーのデータがFirestore上で適切にアカウント（User ID）に紐づき、複数端末間で同期されることを確認・修正する。
  - 必要であれば、ゲスト利用からログインへの移行時にデータを引き継ぐ処理（Account Linking/Data Merge）を検討・実装する。

### 4. Firestoreルールの整理
- [ ] **ルールの棚卸し**
  - 現在の `firestore.rules` を確認し、使用されていないコレクションや不要な許可設定を特定する。
- [ ] **ルールの最適化**
  - 不要なルールを削除し、セキュリティを維持・強化する。

## 手順
1. **環境変数の整理**: `GOOGLE_API_KEY`のリネームとFirebase Configの環境変数化を実施。
2. **GA導入**: Analyticsのセットアップ。
3. **認証・同期改善**: ログインフローの変更とデータ同期検証。
4. **クリーンアップ**: Firestoreルールの修正。

## 手動確認チェックリスト
- [ ] アプリケーションが正常に起動し、APIエラー（Gemini API等）が発生しないこと。
- [ ] 異なる環境（Local/Staging/Prod）で適切なFirebase設定が読み込まれていること。
- [ ] Google Analyticsのダッシュボードでイベントが計測されていること。
- [ ] 未ログイン状態でアプリが利用できること。
- [ ] Googleログイン後、異なる端末（またはブラウザ）で同じデータが参照できること。
- [ ] Firestoreへの読み書きが正しく行われ、権限エラーなどが発生しないこと。
