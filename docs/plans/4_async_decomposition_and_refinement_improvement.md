# 実装計画: 要素分解の非同期UX改善と洗練提案の高度化

## 概要

`docs/todo.md` に基づき、長時間要する要素分解リクエストのUX改善と、理想の状態に対する洗練提案のロジックおよびUIの改善を行う。

## 1. 要素分解リクエストの非同期UX改善

### 現状の課題

- 要素分解（Decomposition）は処理に時間がかかるが、現在はローディング中にUIがブロックされている（または待機を強制されている）可能性がある。
- ユーザー体験を損なわないよう、バックグラウンド処理（または待機可能なモーダル）への移行が必要。

### 実装方針

1. **モーダル表示の変更**:
   - リクエスト開始直後に「処理には時間がかかります」という旨のモーダルを表示。
   - 「閉じる」ボタンを設置し、ユーザーがモーダルを閉じてもバックグラウンドで処理が継続するようにする（あるいは、単にUIをブロックしない通知とする）。
   - **データロック**: レスポンス処理に必要なデータ（対象のツリーノードなど）は、処理中にユーザーが変更できないようにロック状態（編集不可）にする。
   - **視覚的フィードバック**: ロック中の要素は、グレーアウトやローディングインジケータの付与などを行い、ユーザーにとって処理中であることが視覚的に明確になるようにする。

2. **ステータス管理**:
   - フロントエンド側で「分解処理中」のステータスを管理する。
   - 処理完了後、結果を反映しロックを解除する。

### タスク

- [x] 分解リクエスト発火時のUXフロー更新
- [x] 長時間処理警告・待機用モーダルの実装（閉じるボタン付き）
- [x] 処理中の対象ノードのロック機構（編集無効化・視覚的明示）の実装
- [x] レスポンス受信時のデータ反映とロック解除処理
- [ ] 洗練提案（Refinement）リクエストの非同期UX改善（分解と同様のロック・通知処理の適用）

## 2. 理想の状態に対する洗練提案の改善

### 現状の課題

- 「理想の状態」の提案表示モーダルが分かりにくい。
- 入出力の項目が要件を満たしていない可能性がある。
- 「ゴール」に対する提案機能は現状正しいデータ構造・表示になっているため、「理想の状態」に対する提案処理を分離し、特化した実装に切り替える必要がある可能性がある。

### 実装方針

1. **データ構造・プロンプトの更新 (Backend)**:
   - **Input**:
     - `idealState` (理想の状態)
     - `currentState` (現在の状態)
     - `condition` (条件)
   - **Output**:
     - `reasonToKeep` (インプットを維持すべき理由)
     - `refinedIdealState` (洗練後の理想の状態)
     - `refinedCurrentState` (洗練後の現在の状態)
     - `refinedCondition` (洗練後の条件)
     - `reasonToChange` (洗練後に変更すべき理由)
   - AIプロンプトを修正し、上記構造でJSONレスポンスを生成するように調整。

2. **UIの刷新 (Frontend)**:
   - ゴールに対する提案モーダルを参考に、Before/Afterや理由が明確に伝わるデザインに変更する。
   - 3つのフィールド（理想、現状、条件）をセットで表示・比較できるようにする。

### タスク

- [x] Backend: 洗練（Refinement）用AIプロンプトの修正（入力・出力スキーマの変更）
- [x] Backend/Frontend: 提案データ型（`ElementProposal`等）の定義更新（必要であれば）
- [x] Frontend: 洗練提案表示モーダルのレイアウト改修
- [ ] Frontend: モバイルUIのメインコンテンツ下部パディング調整（ナビゲーションとの間隔適正化）
- [ ] GitHub Workflow: `NEXT_PUBLIC_LIMIT_*` 環境変数の定義（本番ビルド時の値注入制御）
- [ ] Frontend: ユーザーメニューの実装（ログアウトボタンの置換、プライバシーポリシー・ログアウトのリスト化）
- [x] Verification: `make verify` による動作確認

## 3. 検証 (Verification)

- `make verify` を実行し、Linter/Buildエラーがないことを確認する。
